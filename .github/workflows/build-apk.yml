  name: Build Android APK

  on:
    push:
      branches: [ main, master ]
    pull_request:
      branches: [ main, master ]
    workflow_dispatch:

  jobs:
    build:
      runs-on: ubuntu-latest
      
      steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
          
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        
      - name: Cache Gradle packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
            
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
        
      - name: Create gradle wrapper jar
        run: |
          mkdir -p gradle/wrapper
          # Download gradle wrapper jar
          curl -L -o gradle/wrapper/gradle-wrapper.jar https://github.com/gradle/gradle/raw/v8.0.0/gradle/wrapper/gradle-wrapper.jar || echo "Download failed, will try alternative"
          
      - name: Build debug APK
        run: ./gradlew assembleDebug --stacktrace
        
      - name: Build release APK
        run: ./gradlew assembleRelease --stacktrace
        
      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: android-autoclick-debug
          path: app/build/outputs/apk/debug/app-debug.apk
          
      - name: Upload Release APK
        uses: actions/upload-artifact@v4
        with:
          name: android-autoclick-release
          path: app/build/outputs/apk/release/app-release-unsigned.apk
          
      - name: Create Release
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v2.0.${{ github.run_number }}
          name: Android AutoClick v2.0.${{ github.run_number }}
          body: |
            ## ğŸ‰ Android è‡ªåŠ¨è¿ç‚¹å™¨ v2.0.${{ github.run_number }}

            ### âœ¨ æ–°åŠŸèƒ½ç‰¹æ€§
            - ğŸ¯ **å¤šç‚¹å‡»æ”¯æŒ** - æ”¯æŒæ·»åŠ å¤šä¸ªç‚¹å‡»ä½ç½®
            - ğŸ”µ **å¯è§†åŒ–åœ†åœˆ** - æ¯ä¸ªç‚¹å‡»ç‚¹æ˜¾ç¤ºç¼–å·åœ†åœˆ
            - âš™ï¸ **ç‹¬ç«‹é…ç½®** - æ¯ä¸ªç‚¹å‡»ç‚¹å¯å•ç‹¬è®¾ç½®é—´éš”å’Œå¯ç”¨çŠ¶æ€
            - ğŸ“± **æœ€å°åŒ–æ¨¡å¼** - åº”ç”¨å¯æœ€å°åŒ–ï¼Œé€šè¿‡æ‚¬æµ®çª—æ§åˆ¶
            - ğŸªŸ **å¢å¼ºæ‚¬æµ®çª—** - ç´§å‡‘çš„æ§åˆ¶é¢æ¿å’Œæ·»åŠ ç‚¹å‡»ç‚¹åŠŸèƒ½
            - ğŸ¨ **é•¿æŒ‰é…ç½®** - é•¿æŒ‰åœ†åœˆå¯å¿«é€Ÿé…ç½®å‚æ•°

            ### ğŸ”§ åŸæœ‰åŠŸèƒ½
            - âœ… è‡ªåŠ¨è¿ç‚¹åŠŸèƒ½
            - âœ… è‡ªå®šä¹‰ç‚¹å‡»åæ ‡å’Œé—´éš”
            - âœ… æ‚¬æµ®çª—æ§åˆ¶é¢æ¿
            - âœ… æƒé™ç®¡ç†ç³»ç»Ÿ
            - âœ… Material Design ç•Œé¢
            
            ### å®‰è£…è¯´æ˜
            1. ä¸‹è½½ `app-debug.apk` æ–‡ä»¶
            2. åœ¨ Android è®¾å¤‡ä¸Šå¼€å¯"æœªçŸ¥æ¥æº"å®‰è£…
            3. å®‰è£… APK æ–‡ä»¶
            4. æˆäºˆæ— éšœç¢æœåŠ¡æƒé™å’Œæ‚¬æµ®çª—æƒé™
            
            ### ç³»ç»Ÿè¦æ±‚
            - Android 5.0 (API 21) åŠä»¥ä¸Šç‰ˆæœ¬
            
            ### æ³¨æ„äº‹é¡¹
            - è¯·åˆç†ä½¿ç”¨ï¼Œéµå®ˆç›¸å…³åº”ç”¨ä½¿ç”¨æ¡æ¬¾
            - é¿å…åœ¨æ•æ„Ÿåº”ç”¨ä¸­ä½¿ç”¨
          files: |
            app/build/outputs/apk/debug/app-debug.apk
            app/build/outputs/apk/release/app-release-unsigned.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
